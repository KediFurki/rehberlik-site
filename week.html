<!doctype html><html lang="tr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hafta</title>
<link rel="stylesheet" href="styles.css">
<link rel="icon" href="/favicon.ico?v=1">
<meta name="title" content="İtalya Rehberlik Takvimi">
<meta name="description" content="İlkokul, ortaokul, lise ve üniversite düzeyleri için aylık rehberlik planları. Ekim 2025 – Aralık 2026 arasında tam müfredat.">
<meta property="og:title" content="İtalya Rehberlik Takvimi">
<meta property="og:description" content="Tüm düzeyler için aylık rehberlik içerikleri ve kaynaklar.">
<meta property="og:type" content="website">
<meta property="og:image" content="/favicon.ico">
<meta name="theme-color" content="#ffffff">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head><body>
<header class="topbar">
  <a href="./">← Ana sayfa</a>
  <div class="brand">📚 Italya Rehberlik Takvimi</div>
  <nav class="nav-right"><a href="admin/">Giriş</a></nav>
</header>

<main class="container">
  <h1 id="hdr">Hafta</h1>

  <section class="block">
    <h3 id="title">Başlık</h3>
    <div id="desc"></div>
  </section>

  <section class="block">
    <h3>Kaynaklar</h3>
    <div id="videoBox" style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px;"></div>
    <ul id="pdfList" class="resources"></ul>
  </section>

  <div id="msg" class="notice"></div>
</main>

<script>
const SUPABASE_URL = "https://itzcgjwfineyyekiaxzx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0emNnandmaW5leXlla2lheHp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1OTQ3NDYsImV4cCI6MjA3NTE3MDc0Nn0.ZKn2w3MV5uHn1yaX2_8utmYlTLfeGP7BrntSUWvKrks";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ?level=...&year=...&month=...&week=...
const q = new URLSearchParams(location.search);
const level = q.get('level'); const year = +q.get('year'); const month = +q.get('month'); const week = +q.get('week');
document.getElementById('hdr').textContent = `${level} • ${year} • ${haftaAd(week)}`;

(async ()=>{
  if(!isValid()){ document.getElementById('msg').textContent='Geçersiz adres parametresi.'; return; }
  const { data, error } = await sb.from('weeks').select('*')
    .eq('level',level).eq('year',year).eq('month',month).eq('week',week).maybeSingle();
  if(error){ document.getElementById('msg').textContent='Hata: '+error.message; return; }
  if(!data){ document.getElementById('msg').textContent='Henüz içerik eklenmedi.'; return; }

  document.getElementById('title').textContent = data.title || 'Başlık';
  document.getElementById('desc').innerHTML  = toRichHtml(data.description||'');

  renderVideo(data.video_url);
  renderVideo(data.video_url2);
  renderVideo(data.video_url3);

  renderPdfList([data.pdf_url, data.pdf_url2, data.pdf_url3].filter(Boolean));
})();

/* ---------- helpers ---------- */
function haftaAd(w){return `${w}. Hafta`;}
function isValid(){
  return ['ilkokul','ortaokul','lise','universite'].includes(level)
    && (year===2025 || year===2026) && month>=1 && month<=12 && week>=1 && week<=4;
}
function youtubeId(u){
  try{
    const url = new URL(u);
    const h = url.hostname.replace(/^www\./,'');
    if (h==='youtu.be') return url.pathname.slice(1);
    if (h==='youtube.com' || h==='m.youtube.com'){
      if (url.searchParams.get('v')) return url.searchParams.get('v');
      const p=url.pathname.split('/').filter(Boolean);
      if (p[0]==='embed' && p[1]) return p[1];
      if (p[0]==='shorts'&& p[1]) return p[1];
    }
  }catch(e){}
  return null;
}
function renderVideo(u){
  if(!u) return;
  const id = youtubeId(u); if(!id) return;
  const box = document.getElementById('videoBox');
  const a = document.createElement('a');
  a.href=u; a.target='_blank'; a.rel='noopener';
  a.style.display='inline-block'; a.style.border='1px solid #e5e7eb'; a.style.borderRadius='12px'; a.style.overflow='hidden';
  a.innerHTML = `<img src="https://i.ytimg.com/vi/${id}/hqdefault.jpg" alt="Video" style="display:block;width:360px;height:auto">`;
  box.appendChild(a);
}
function cleanFileName(name){
  // haftanın ve timestampin eklendiği prefixi kaldır: "hafta-<n>-<ts>-"
  return name.replace(/^hafta-\d+-\d+-/,'');
}
function fileNameFromUrl(u){
  try{ const raw = decodeURIComponent(new URL(u).pathname.split('/').pop()); return cleanFileName(raw); }
  catch(e){ return 'PDF'; }
}
function renderPdfList(urls){
  const ul = document.getElementById('pdfList');
  ul.innerHTML = urls.map(u => `<li><a href="${u}" target="_blank" rel="noopener">${fileNameFromUrl(u)}</a></li>`).join('');
}
function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function toRichHtml(text){
  let s = escapeHtml(text).replace(/\r\n/g,'\n');
  // **kalın**
  s = s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  // paragraflar: boş satıra göre böl
  return '<p>'+ s.split(/\n{2,}/).map(p=>p.replace(/\n/g,'<br>')).join('</p><p>') + '</p>';
}
</script>
</body></html>