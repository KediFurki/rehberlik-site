<!doctype html><html lang="tr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Paneli</title>
<link rel="stylesheet" href="../styles.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{background:#f6f7fb}
form,.row{display:grid;gap:8px;max-width:660px}
.row{grid-template-columns:repeat(4,1fr)}
input,select,textarea,button{padding:10px;border:1px solid #e5e7eb;border-radius:10px}
textarea{min-height:120px}
.notice{color:#0a7;margin:8px 0}
.err{color:#c00;margin:8px 0}
</style>
</head><body>
<header class="topbar"><a href="../">← Site</a></header>
<main class="container">
  <h1>Admin Paneli</h1>

  <section class="block" id="auth">
    <h3>Giriş</h3>
    <div class="row" style="grid-template-columns:1fr 1fr 120px">
      <input id="email" type="email" placeholder="E-posta">
      <input id="password" type="password" placeholder="Şifre">
      <button id="btnLogin">Giriş</button>
    </div>
    <div id="authMsg" class="notice"></div>
  </section>

  <section class="block" id="editor" style="display:none">
    <h3>Hafta Düzenle</h3>
    <div class="row">
      <select id="level">
        <option>ilkokul</option><option selected>ortaokul</option>
        <option>lise</option><option>universite</option>
      </select>
      <select id="year"><option>2025</option><option>2026</option></select>
      <select id="month"></select>
      <select id="week"><option>1</option><option>2</option><option>3</option><option>4</option></select>
    </div>

    <input id="title" placeholder="Konu başlığı">
    <textarea id="description" placeholder="Açıklama / metin"></textarea>
    <input id="video_url" placeholder="Video bağlantısı (YouTube vs)">
    <div class="row" style="grid-template-columns:1fr 140px">
      <input id="pdf_url" placeholder="PDF adresi (otomatik dolar)">
      <input id="pdf" type="file" accept="application/pdf">
    </div>

    <div class="row" style="grid-template-columns:160px 140px 1fr">
      <button id="btnLoad">Veriyi Getir</button>
      <button id="btnSave">Kaydet</button>
      <div id="msg" class="notice"></div>
    </div>
    <div id="err" class="err"></div>
  </section>
</main>

<script>
const SUPABASE_URL = "https://itzcgjwfineyyekiaxzx.supabase.co"; // kendi URL'ini yaz
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0emNnandmaW5leXlla2lheHp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1OTQ3NDYsImV4cCI6MjA3NTE3MDc0Nn0.ZKn2w3MV5uHn1yaX2_8utmYlTLfeGP7BrntSUWvKrks"; // kendi anon key
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Ay seçenekleri
const months = [
  {n:1,t:'Ocak'},{n:2,t:'Şubat'},{n:3,t:'Mart'},{n:4,t:'Nisan'},{n:5,t:'Mayıs'},{n:6,t:'Haziran'},
  {n:7,t:'Temmuz'},{n:8,t:'Ağustos'},{n:9,t:'Eylül'},{n:10,t:'Ekim'},{n:11,t:'Kasım'},{n:12,t:'Aralık'}
];
const mSel = document.getElementById('month');
months.forEach(m=>{const o=document.createElement('option');o.value=m.n;o.textContent=m.t;mSel.appendChild(o)});
mSel.value=10;

// Giriş
document.getElementById('btnLogin').onclick=async()=>{
  const email=document.getElementById('email').value.trim();
  const password=document.getElementById('password').value;
  const {data,error}=await sb.auth.signInWithPassword({email,password});
  if(error){document.getElementById('authMsg').textContent="Giriş hatası: "+error.message;return;}
  document.getElementById('auth').style.display='none';
  document.getElementById('editor').style.display='';
  document.getElementById('authMsg').textContent="Giriş başarılı.";
};

// PDF yükleme
async function uploadPdf(file,path){
  const {data,error}=await sb.storage.from('uploads').upload(path,file,{upsert:true,contentType:'application/pdf'});
  if(error)throw error;
  const {data:pub}=sb.storage.from('uploads').getPublicUrl(path);
  return pub.publicUrl;
}

// Anahtar okuma
function readKey(){return{
  level:document.getElementById('level').value,
  year:parseInt(document.getElementById('year').value),
  month:parseInt(document.getElementById('month').value),
  week:parseInt(document.getElementById('week').value)
};}

// Form doldurma / temizleme
function fillForm(d){document.getElementById('title').value=d.title||'';document.getElementById('description').value=d.description||'';document.getElementById('video_url').value=d.video_url||'';document.getElementById('pdf_url').value=d.pdf_url||'';}
function clearForm(){fillForm({});}

// Veri yükleme
document.getElementById('btnLoad').onclick=async()=>{
  const k=readKey();
  const {data,error}=await sb.from('weeks').select('*')
    .eq('level',k.level).eq('year',k.year).eq('month',k.month).eq('week',k.week).maybeSingle();
  if(error){document.getElementById('err').textContent=error.message;return;}
  if(!data){clearForm();document.getElementById('msg').textContent='Kayıt yok. Oluşturabilirsiniz.';return;}
  fillForm(data);document.getElementById('msg').textContent='Kayıt yüklendi.';
};

// Kaydet
document.getElementById('btnSave').onclick=async()=>{
  const k=readKey();
  const file=document.getElementById('pdf').files[0];
  let pdf_url=document.getElementById('pdf_url').value.trim();
  if(file){
    try{pdf_url=await uploadPdf(file,`${k.level}/${k.year}/${k.month}/hafta-${k.week}.pdf`);
      document.getElementById('pdf_url').value=pdf_url;
    }catch(e){document.getElementById('err').textContent="PDF yükleme hatası: "+e.message;return;}
  }
  const payload={level:k.level,year:k.year,month:k.month,week:k.week,
    title:document.getElementById('title').value.trim(),
    description:document.getElementById('description').value.trim(),
    video_url:document.getElementById('video_url').value.trim(),
    pdf_url};
  const {error}=await sb.from('weeks').upsert(payload,{onConflict:'level,year,month,week'});
  if(error){document.getElementById('err').textContent=error.message;return;}
  document.getElementById('msg').textContent='Kaydedildi.';
};
</script>
</body></html>