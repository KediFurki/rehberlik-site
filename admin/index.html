<!doctype html><html lang="tr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Paneli</title>
<link rel="stylesheet" href="../styles.css">
<link rel="icon" href="/favicon.ico?v=1">
<meta name="title" content="ƒ∞talya Rehberlik Takvimi">
<meta name="description" content="ƒ∞lkokul, ortaokul, lise ve √ºniversite d√ºzeyleri i√ßin aylƒ±k rehberlik planlarƒ±. Ekim 2025 ‚Äì Aralƒ±k 2026.">
<meta property="og:title" content="ƒ∞talya Rehberlik Takvimi">
<meta property="og:description" content="T√ºm d√ºzeyler i√ßin aylƒ±k rehberlik i√ßerikleri ve kaynaklar.">
<meta property="og:type" content="website">
<meta property="og:image" content="/favicon.ico">
<meta name="theme-color" content="#ffffff">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{background:#f6f7fb}
form,.row{display:grid;gap:8px;max-width:760px}
.row{grid-template-columns:repeat(4,1fr)}
input,select,textarea,button{padding:10px;border:1px solid #e5e7eb;border-radius:10px}
textarea{min-height:120px}
.notice{color:#0a7;margin:8px 0}
.err{color:#c00;margin:8px 0}
</style>
</head><body>
<header class="topbar">
  <a href="../" target="_blank" rel="noopener">‚Üê Site</a>
  <div class="brand">üìö Italya Rehberlik Takvimi</div>
  <nav class="nav-right"></nav>
</header>

<main class="container">
  <h1>Admin Paneli</h1>

  <section class="block" id="auth">
    <h3>Giri≈ü</h3>
    <div class="row" style="grid-template-columns:1fr 1fr 120px">
      <input id="email" type="email" placeholder="E-posta">
      <input id="password" type="password" placeholder="≈ûifre">
      <button id="btnLogin">Giri≈ü</button>
    </div>
    <div id="authMsg" class="notice"></div>
  </section>

  <section class="block" id="editor" style="display:none">
    <h3>Hafta D√ºzenle</h3>
    <div class="row">
      <select id="level">
        <option>ilkokul</option><option selected>ortaokul</option>
        <option>lise</option><option>universite</option>
      </select>
      <select id="year"><option>2025</option><option>2026</option></select>
      <select id="month"></select>
      <select id="week"><option>1</option><option>2</option><option>3</option><option>4</option></select>
    </div>

    <input id="title" placeholder="Konu ba≈ülƒ±ƒüƒ±">
    <textarea id="description" placeholder="A√ßƒ±klama / metin (satƒ±r sonlarƒ± korunur, **kalƒ±n** destekli)"></textarea>

    <!-- 2 video -->
    <input id="video_url"  placeholder="Video 1 baƒülantƒ±sƒ± (YouTube)">
    <input id="video_url2" placeholder="Video 2 baƒülantƒ±sƒ± (opsiyonel)">
    <input id="video_url3" placeholder="Video 3 baƒülantƒ±sƒ± (opsiyonel)">

    <!-- 3 PDF -->
    <div class="row" style="grid-template-columns:1fr 140px">
      <input id="pdf_url"  placeholder="PDF 1 adresi (otomatik dolar)">
      <input id="pdf" type="file" accept="application/pdf">
    </div>
    <div class="row" style="grid-template-columns:1fr 140px">
      <input id="pdf_url2" placeholder="PDF 2 adresi (opsiyonel)">
      <input id="pdf2" type="file" accept="application/pdf">
    </div>
    <div class="row" style="grid-template-columns:1fr 140px">
      <input id="pdf_url3" placeholder="PDF 3 adresi (opsiyonel)">
      <input id="pdf3" type="file" accept="application/pdf">
    </div>

    <div class="row" style="grid-template-columns:160px 140px 1fr">
      <button id="btnLoad">Veriyi Getir</button>
      <button id="btnSave">Kaydet</button>
      <div id="msg" class="notice"></div>
    </div>
    <div id="err" class="err"></div>
  </section>
</main>

<script>
const SUPABASE_URL = "https://itzcgjwfineyyekiaxzx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0emNnandmaW5leXlla2lheHp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1OTQ3NDYsImV4cCI6MjA3NTE3MDc0Nn0.ZKn2w3MV5uHn1yaX2_8utmYlTLfeGP7BrntSUWvKrks";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {auth:{persistSession:true,autoRefreshToken:true}});

const nav = document.querySelector('.nav-right');
const auth = document.getElementById('auth');
const editor = document.getElementById('editor');
const authMsg = document.getElementById('authMsg');

function renderNavBase(){
  nav.innerHTML = `<a href="../panel/">Mentor Paneli</a>
                   <a href="./checklist.html" style="margin-left:8px">Checklist</a>`;
}
async function showUser(){
  renderNavBase();
  const { data:{ user } } = await sb.auth.getUser();
  if (user){
    const span = document.createElement('span'); span.textContent = 'üë§ '+(user.email||'Admin'); span.style.marginLeft='8px';
    const btn = document.createElement('button'); btn.textContent='√áƒ±kƒ±≈ü'; btn.style.marginLeft='8px'; btn.onclick=async()=>{await sb.auth.signOut(); location.href='../';};
    nav.append(span, btn);
    auth.style.display='none'; editor.style.display='';
  }else{
    const a = document.createElement('a'); a.href='../admin/'; a.textContent='Giri≈ü'; a.style.marginLeft='8px';
    nav.appendChild(a);
    auth.style.display=''; editor.style.display='none';
  }
}
showUser();

document.getElementById('btnLogin').onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if (error){ authMsg.textContent = "Giri≈ü hatasƒ±: " + error.message; return; }
  authMsg.textContent = "Giri≈ü ba≈üarƒ±lƒ±."; showUser();
};

const months=[{n:1,t:'Ocak'},{n:2,t:'≈ûubat'},{n:3,t:'Mart'},{n:4,t:'Nisan'},{n:5,t:'Mayƒ±s'},{n:6,t:'Haziran'},{n:7,t:'Temmuz'},{n:8,t:'Aƒüustos'},{n:9,t:'Eyl√ºl'},{n:10,t:'Ekim'},{n:11,t:'Kasƒ±m'},{n:12,t:'Aralƒ±k'}];
const mSel=document.getElementById('month'); months.forEach(m=>{const o=document.createElement('option');o.value=m.n;o.textContent=m.t;mSel.appendChild(o)}); mSel.value=10;

async function uploadPdf(file,path){
  const { error }=await sb.storage.from('uploads').upload(path,file,{upsert:true,contentType:'application/pdf'});
  if(error) throw error;
  const { data:pub } = sb.storage.from('uploads').getPublicUrl(path);
  return pub.publicUrl;
}
function readKey(){return{
  level:level.value, year:+year.value, month:+month.value, week:+week.value
};}
function fillForm(d){
  title.value=d.title||'';
  description.value=d.description||'';
  video_url.value=d.video_url||'';
  video_url2.value=d.video_url2||'';
  video_url3.value=d.video_url3||'';
  pdf_url.value=d.pdf_url||'';
  document.getElementById('pdf_url2').value=d.pdf_url2||'';
  document.getElementById('pdf_url3').value=d.pdf_url3||'';
}
function clearForm(){ fillForm({}); }
function uniquePath(k,file){
  const safe=file.name.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9.\-]/g,'');
  return `${k.level}/${k.year}/${k.month}/hafta-${k.week}-${Date.now()}-${safe}`;
}

document.getElementById('btnLoad').onclick=async()=>{
  const k=readKey();
  const { data, error } = await sb.from('weeks').select('*')
    .eq('level',k.level).eq('year',k.year).eq('month',k.month).eq('week',k.week).maybeSingle();
  if(error){ err.textContent=error.message; return; }
  if(!data){ clearForm(); msg.textContent='Kayƒ±t yok. Olu≈üturabilirsiniz.'; return; }
  fillForm(data); msg.textContent='Kayƒ±t y√ºklendi.';
};

document.getElementById('btnSave').onclick=async()=>{
  const k=readKey();
  const f1=document.getElementById('pdf').files[0];
  const f2=document.getElementById('pdf2').files[0];
  const f3=document.getElementById('pdf3').files[0];
  let pdf1=pdf_url.value.trim();
  let pdf2=document.getElementById('pdf_url2').value.trim();
  let pdf3=document.getElementById('pdf_url3').value.trim();

  try{
    if(f1){ pdf1=await uploadPdf(f1,uniquePath(k,f1)); pdf_url.value=pdf1; }
    if(f2){ pdf2=await uploadPdf(f2,uniquePath(k,f2)); document.getElementById('pdf_url2').value=pdf2; }
    if(f3){ pdf3=await uploadPdf(f3,uniquePath(k,f3)); document.getElementById('pdf_url3').value=pdf3; }
  }catch(e){ err.textContent="PDF y√ºkleme hatasƒ±: "+e.message; return; }

  const payload={
    level:k.level, year:k.year, month:k.month, week:k.week,
    title:title.value.trim(),
    description:description.value.trim(),
    video_url:video_url.value.trim(),
    video_url2:video_url2.value.trim()||null,
    video_url3:video_url3.value.trim()||null,
    pdf_url:pdf1||null, pdf_url2:pdf2||null, pdf_url3:pdf3||null
  };

  const { error }=await sb.from('weeks').upsert(payload,{onConflict:'level,year,month,week'});
  if(error){ err.textContent=error.message; return; }
  msg.textContent='Kaydedildi.';
};
</script>
</body></html>